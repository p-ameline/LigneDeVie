package com.ldv.client.mvp_toons;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;

import com.allen_sauer.gwt.log.client.Log;
import com.google.gwt.core.client.Scheduler;
import com.google.gwt.core.client.Scheduler.ScheduledCommand;
import com.google.gwt.user.client.DOM;
import com.google.gwt.user.client.ui.AbsolutePanel;
import com.google.inject.Inject;
import com.ldv.client.canvas.LdvBoxSeverity;
import com.ldv.client.event.LdvConcernLineInitEvent;
import com.ldv.client.event.LdvConcernLineInitEventHandler;
import com.ldv.client.event.LdvDocumentInitEvent;
import com.ldv.client.event.LdvRedrawProjectWindowEvent;
import com.ldv.client.event.LdvRedrawConcernLineEvent;
import com.ldv.client.event.LdvRedrawConcernLineEventHandler;
import com.ldv.client.model.LdvModelConcern;
import com.ldv.client.model.LdvModelConcernSeverityLevel;
import com.ldv.client.model.LdvModelDocument;
import com.ldv.client.mvp.LdvProjectWindowPresenter;
import com.ldv.client.util.LdvSupervisor;
import com.ldv.shared.model.LdvTime;

import net.customware.gwt.presenter.client.EventBus;
import net.customware.gwt.presenter.client.place.Place;
import net.customware.gwt.presenter.client.place.PlaceRequest;
import net.customware.gwt.presenter.client.widget.WidgetDisplay;
import net.customware.gwt.presenter.client.widget.WidgetPresenter;

public class LdvConcernLinePresenter extends WidgetPresenter<LdvConcernLinePresenter.Display>
{
	public interface Display extends WidgetDisplay 
	{	
		public void setID(int linenumber) ;
		public void setWidth(int width) ;
		public void setTitle(String title) ;
		public void setPosition(int left, int top) ;
		public String getMainPanelId() ;
		public void addSeverityBox(LdvBoxSeverity boxSeverity) ;
		public AbsolutePanel getMainPanel() ;
		public ArrayList<LdvBoxSeverity> getSeverityBoxList() ;
		public void setSeverityBoxList(ArrayList<LdvBoxSeverity> boxSeverityList) ;
		public void ReAddSeverityBox() ;
	}

	private final LdvSupervisor _supervisor ;
	public static final Place PLACE = new Place("Time Controler") ;
	
	private final int concernLineHeight = 32 ;
	private final int margin = 10 ;
	
	private ScheduledCommand 					  _pendingEvents = null ;
	protected LdvProjectWindowPresenter _project ;
	private 	AbsolutePanel							_projectPanel;
	private   LdvModelConcern						_model ; 
	private 	LdvTime										_startTime ;
	private   int 											_startPosition ;
	private   int 											_endPosition ;
	private 	int 											_width ;
	private 	int 											_top ;
	private 	int 											_lineNumber ;
	private   String										_title ;
	private 	int  								    	_projectWindowWidth ;
	private 	ArrayList<LdvModelConcernSeverityLevel> _severityArray ;
	private 	ArrayList<LdvTime> 				_dateSeverityArray ;
	private 	HashMap<Integer, String>	_severityColor;
	private 	String 										_levelOneColor	= "#1C65AA" ; //blue
	private   String										_levelTwoColor = "#C3D388" ;  //green
	private   String										_levelThreeColor = "#E6E267" ; //yellow
	private   String										_levelFourColor = "#BC2838" ; //red
	private   ArrayList<LdvModelDocument> _documentArray ;
	
	@Inject
	public LdvConcernLinePresenter(final Display display, EventBus eventBus, LdvSupervisor supervisor) 
	{	
		super(display, eventBus);		
		_supervisor = supervisor ;
		bind();
		initSeverityColor();
		Log.info("entering constructor of LdvConcernLinePresenter.");
	}
	  
	@Override
	public Place getPlace() {
		return PLACE ;
	}
	
	public void initSeverityColor(){
		
		_severityColor = new HashMap<Integer, String>() ;
		int severityValue;
		
		//set level one color
		for(severityValue=0;severityValue<26;severityValue++){
			this._severityColor.put(severityValue, _levelOneColor) ;
		}
		
		//set level two color
		for(severityValue=26;severityValue<51;severityValue++){
			this._severityColor.put(severityValue, _levelTwoColor) ;
		}
		
		//set level three color
		for(severityValue=51;severityValue<76;severityValue++){
			this._severityColor.put(severityValue, _levelThreeColor) ;
		}
		
		//set level four color
		for(severityValue=76;severityValue<101;severityValue++){
			this._severityColor.put(severityValue, _levelFourColor) ;
		}		
	}

	public void connectToProject(LdvConcernLineInitEvent event) 
	{	
		if (event.getTarget() != this)
		{	
			return ;
		}
			
		_project = event.getFather() ;
		_model = event.getModel() ;
		_lineNumber = event.getLineNumber() ;
				
		_startTime = _model.getBeginDate() ;
		_startPosition = Math.max(this.getProjectPosition(_startTime), 0) ;
		_endPosition   = this.getProjectPosition(_model.getEndDate()) ;
		_width = _endPosition - _startPosition ;
		_title = _model.getTitle() ;
		_top = margin + (concernLineHeight + margin) * _lineNumber ; 
		
		display.setID(_lineNumber) ;
		display.setWidth(_width) ;
		display.setTitle(_title) ;
		display.setPosition(_startPosition, _top) ;
		
		//set the severities boxes
		//
		_severityArray = (ArrayList<LdvModelConcernSeverityLevel>)_model.getSeverityArray() ;
		_dateSeverityArray = new ArrayList<LdvTime>() ;
		
		//get the start date of the severities
		for(Iterator<LdvModelConcernSeverityLevel> iter = _severityArray.iterator();iter.hasNext();){
			LdvModelConcernSeverityLevel severity = iter.next() ; 
			LdvTime startDate = severity.getDate() ; 
			_dateSeverityArray.add(startDate) ;			
		}
		_dateSeverityArray.add(_model.getEndDate()) ;
		
		int indexDateSeverityArray = 0;
		for(Iterator<LdvModelConcernSeverityLevel> iter = _severityArray.iterator();iter.hasNext();){
			
			LdvModelConcernSeverityLevel severity = iter.next() ; 
			LdvTime startTime = _dateSeverityArray.get(indexDateSeverityArray) ;
			LdvTime endTime = _dateSeverityArray.get(indexDateSeverityArray+1) ;
			
			LdvBoxSeverity boxSeverity = new LdvBoxSeverity(startTime, endTime) ;
		
			int startPosition = this.getLinePosition(startTime) ;
			int endPosition = this.getLinePosition(endTime) ;
			int boxSeverityWidth = endPosition - startPosition ;
		
			int severityLevel = severity.getSeverityLevel() ;
						
			boxSeverity.setStartPosition(startPosition) ;
			boxSeverity.setEndPosition(endPosition) ;
			boxSeverity.setBoxWidth(boxSeverityWidth) ;
			boxSeverity.setColor(this._severityColor.get(severityLevel)) ;
			
			display.addSeverityBox(boxSeverity) ;	
			
			indexDateSeverityArray++ ;
		}
		
		//add the documents
		_documentArray = event.getModelDocumentArray() ;
		for(Iterator<LdvModelDocument> iter = _documentArray.iterator(); iter.hasNext();){
			LdvModelDocument documentModel = iter.next() ;
			LdvDocumentPresenter document = _supervisor.getInjector().getDocumentPresenter() ;
			initDocument(document, documentModel);
		}
	 	
		_projectPanel = (AbsolutePanel) event.getProject() ; //ProjectWindow		
		_projectPanel.add(getDisplay().asWidget()) ;
	}
	
	public void initDocument(final LdvDocumentPresenter document, final LdvModelDocument documentModel) {
		
		if (false == eventBus.isEventHandled(LdvDocumentInitEvent.TYPE))
		{
			_pendingEvents = new ScheduledCommand() 
				{
					public void execute() {
						_pendingEvents = null ;
						initDocument(document, documentModel) ;
			     }
				};
			 Scheduler.get().scheduleDeferred(_pendingEvents) ;
		}
		else
		{	
			eventBus.fireEvent(new LdvDocumentInitEvent(display.getMainPanel(), document, this, documentModel)) ;
		}			
	}
	
	public void redraw(LdvRedrawConcernLineEvent event){
		
		//Log.info("entering redraw concern line.");
		if ((event.getTarget()!=this)||(event.getFather()!=_project))
		{	
			return ;
		}
		_startPosition = this.getProjectPosition(_model.getBeginDate()) ;
		_endPosition = this.getProjectPosition(_model.getEndDate()) ;

		_projectWindowWidth = _project.getDisplay().getMainPanel().getElement().getOffsetWidth() ;
		
		//once startPosition equal to 0, we keep startPosition of the line 0
		//and decrease the width of the panel, to make the line seem to move.
		if(_startPosition < 0){
	
			redrawBox() ;
			//redrawDocument() ;
			_startPosition = 0 ;
			_width = _endPosition ;
			
			if(_endPosition < 0){
				return ;
			}
		}else if(_endPosition > _projectWindowWidth){
			
			redrawBox() ;
			_endPosition = _projectWindowWidth ;
			_width = _projectWindowWidth - _startPosition ;
			
			if(_startPosition > _projectWindowWidth){
				return ;
			}
		}
		
		display.setID(_lineNumber) ;
		display.setWidth(_width) ;
		display.setPosition(_startPosition, _top) ;
			
		_projectPanel.add(getDisplay().asWidget()) ;		
	}
	
	public void redrawBox(){
		ArrayList<LdvBoxSeverity> severityBoxList = display.getSeverityBoxList() ;
		ArrayList<LdvBoxSeverity> newSeverityBoxList = new ArrayList<LdvBoxSeverity>() ;
		for(Iterator<LdvBoxSeverity> iter = severityBoxList.iterator();iter.hasNext();){
			LdvBoxSeverity severityBox = iter.next() ;
			LdvTime start_time = severityBox.getStartTime() ;
			LdvTime end_time = severityBox.getEndTime() ;
			int start_Position = this.getProjectPosition(start_time) ;
			int end_Position = this.getProjectPosition(end_time) ;
			
			if(end_Position <= 0){	
				severityBox.setStartPosition(0) ;
				severityBox.setEndPosition(0) ;  //make the values more safe   
				severityBox.setBoxWidth(0) ;
			}else{
			  // start_Position <= 0 and endPosition > 0
				if(start_Position <= 0){
					severityBox.setStartPosition(0) ;
					severityBox.setEndPosition(this.getLinePosition(end_time)) ;
					severityBox.setBoxWidth(end_Position) ;
				}else if(end_Position >= _projectWindowWidth){
					if(start_Position >= _projectWindowWidth){
						//todo: severityBox.setStartPosition(?) ; 
						//todo: severityBox.setEndPosition(?) ;
						severityBox.setBoxWidth(0) ;
					}else{
						//start_Position < _projectWindowWidth and endPosition > _projectWindowWidth
						severityBox.setBoxWidth(_projectWindowWidth - start_Position) ;
					 }					
				 }else{
					//startPosition > 0 and 0 < endPosition < _projectWindowWidth
					severityBox.setStartPosition(this.getLinePosition(start_time)) ;
					severityBox.setEndPosition(this.getLinePosition(end_time)) ;	
					severityBox.setBoxWidth(severityBox.getEndPosition() - severityBox.getStartPosition()) ;
				}
			}		
			newSeverityBoxList.add(severityBox) ;
		}
		display.setSeverityBoxList(newSeverityBoxList) ;	
		display.ReAddSeverityBox() ;
	}
	
	public void redrawDocument(){
		
	}
	
	public int getProjectPosition(LdvTime ldvTime){
		return (int)_project.getInternalPhysicalPosition(ldvTime) ;
	}	
	
	public int getLinePosition(LdvTime ldvTime){
		//int lineOffsetLeft = DOM.getElementPropertyInt(display.getMainPanel().getElement(), "offsetLeft");		
		int lineOffsetLeft = this.getProjectPosition(_startTime);
		int projectPosition = this.getProjectPosition(ldvTime) ;
		int max = Math.max(lineOffsetLeft, 0) ;
		int result = projectPosition - max ;
		return result ;
		
		//return (this.getProjectPosition(ldvTime) - Math.max(lineOffsetLeft, 0));
	}

	@Override
	protected void onBind() 
	{			
		eventBus.addHandler(LdvConcernLineInitEvent.TYPE, new LdvConcernLineInitEventHandler() 
		{
			@Override
			public void onInitSend(LdvConcernLineInitEvent event) 
			{
				Log.info("Handling LdvConcernLineInitEvent event");
				connectToProject(event) ;
			}
		});
		
		eventBus.addHandler(LdvRedrawConcernLineEvent.TYPE, new LdvRedrawConcernLineEventHandler() 
		{
			@Override
			public void onRedrawConcernLineSend(LdvRedrawConcernLineEvent event) 
			{
				Log.info("Handling LdvRedrawConcernLineEvent event");
				redraw(event) ;
			}
		});
	}

	@Override
	protected void onPlaceRequest(PlaceRequest request) {
		
	}

	@Override
	protected void onUnbind() {
		
	}

	@Override
	public void refreshDisplay() {
		
	}

	@Override
	public void revealDisplay() {
		
	}

}
